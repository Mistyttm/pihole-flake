name: Format Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  nixpkgs-fmt:
    name: Check Nix Formatting (nixpkgs-fmt)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          flakehub: false
          extra-conf: |
            fallback = true
            connect-timeout = 10
            stalled-download-timeout = 10

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check formatting with nixpkgs-fmt
        run: |
          nix-shell -p nixpkgs-fmt --run "nixpkgs-fmt --check ."

  alejandra:
    name: Check Nix Formatting (alejandra)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          flakehub: false
          extra-conf: |
            fallback = true
            connect-timeout = 10
            stalled-download-timeout = 10

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check formatting with alejandra
        run: |
          nix-shell -p alejandra --run "alejandra --check ."
        continue-on-error: true

  nixfmt:
    name: Check Nix Formatting (nixfmt-rfc-style)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          flakehub: false
          extra-conf: |
            fallback = true
            connect-timeout = 10
            stalled-download-timeout = 10

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check formatting with nixfmt
        run: |
          nix-shell -p nixfmt-rfc-style --run "nixfmt --check ."
        continue-on-error: true

  statix:
    name: Lint Nix Code (statix)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          flakehub: false
          extra-conf: |
            fallback = true
            connect-timeout = 10
            stalled-download-timeout = 10

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run statix linter
        run: |
          nix-shell -p statix --run "statix check ."

  deadnix:
    name: Check Dead Code (deadnix)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          flakehub: false
          extra-conf: |
            fallback = true
            connect-timeout = 10
            stalled-download-timeout = 10

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check for dead code
        run: |
          nix-shell -p deadnix --run "deadnix --fail ."

  summary:
    name: Format Check Summary
    runs-on: ubuntu-latest
    needs: [nixpkgs-fmt, statix, deadnix]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Format Check Summary"
          echo "===================="
          echo "nixpkgs-fmt: ${{ needs.nixpkgs-fmt.result }}"
          echo "statix: ${{ needs.statix.result }}"
          echo "deadnix: ${{ needs.deadnix.result }}"
          
          if [ "${{ needs.nixpkgs-fmt.result }}" != "success" ] || \
             [ "${{ needs.statix.result }}" != "success" ] || \
             [ "${{ needs.deadnix.result }}" != "success" ]; then
            echo ""
            echo "❌ Format checks failed"
            echo ""
            echo "To fix formatting issues locally, run:"
            echo "  nix-shell -p nixpkgs-fmt --run 'nixpkgs-fmt .'"
            echo ""
            echo "To fix linting issues, run:"
            echo "  nix-shell -p statix --run 'statix fix .'"
            exit 1
          else
            echo ""
            echo "✅ All format checks passed"
          fi
